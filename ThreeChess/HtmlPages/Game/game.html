<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess for Three - Игровая доска</title>
    <link rel="stylesheet" href="/styles/board.css?v=2.1" />
    <link rel="stylesheet" href="/styles/header.css?v=1.1">
    <link rel="stylesheet" href="/styles/move-history.css?v=1.7">
</head>
<body>
    <!-- Основной контейнер для контента страницы -->
    <div class="content-container">
        <!-- Контейнер для доски -->
        <div class="board-container">
            <svg width="702"
                 height="702"
                 viewBox="0 0 700 700"
                 alignment-baseline="central">
                <g id="cells-layer"></g>
                <g id="labels-layer"></g>
                <g id="figures-layer"></g>
            </svg>
        </div>

        <!-- Боковое меню с информацией о игре -->
        <aside class="game-info">
            <h2>Таймер</h2>
            <ul id="timers-list">
                <li data-color="White">
                    <span class="timer-label">Белый:</span>
                    <span class="timer-value" id="timer-White">--:--</span>
                </li>
                <li data-color="Black">
                    <span class="timer-label">Черный:</span>
                    <span class="timer-value" id="timer-Black">--:--</span>
                </li>
                <li data-color="Red">
                    <span class="timer-label">Красный:</span>
                    <span class="timer-value" id="timer-Red">--:--</span>
                </li>
            </ul>
            <h2 style="margin-top: 30px;">История ходов</h2>
            <div id="moves-history">
                <div class="loading-moves">Загрузка истории ходов...</div>
            </div>
        </aside>
    </div>

    <!-- Скрипты остаются без изменений -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="/scripts/highlightMoves.js?v=2.5"></script>
    <script src="/scripts/renderBoard.js?v=1.6"></script>
    <script src="/scripts/loadCells.js?v=2.7"></script>
    <script src="/scripts/validatePolygon.js?v=1.4"></script>
    <script src="/scripts/moveFigures.js?v=2.9"></script>
    <script src="/scripts/figureClickHandlers.js?v=2.0"></script>
    <script>
        const parts = window.location.pathname.split('/');
        const gameId = parts[parts.length - 1];
        const VIEWBOX_SIZE = 698;
        const CENTER_OFFSET = 350;
        const FIGURE_SIZE = 46;

        const boardElementsState = {
            cells: {}
        };

        const movedElements = {
            diagonals: {},
            mainLines: {},
            secondaryLines: {}
        };

        const gameConfig = {
            color: undefined,
        };

        let last_click_id = undefined;

        const gameHub = new signalR.HubConnectionBuilder()
            .withUrl("/moveHub")
            .build();

        gameHub.on("handleMove", function (moveResponse) {
            try {
                if (moveResponse.userId !== gameConfig.userId) {
                    moveFigure(moveResponse.startCellId, moveResponse.endCellId);
                }
                
                gameConfig.playerGameTimes = moveResponse.playerGameTimes;

                updateTimers();


                const historyContainer = document.getElementById('moves-history');
                const moveCount = historyContainer.children.length;
                const turnColor = getTurnColorByIndex(moveCount);

                const moveItem = document.createElement('div');
                moveItem.className = 'move-item';
                moveItem.innerHTML = `
                    <span class="move-number">${moveCount + 1}.</span>
                    <span class="move-cells ${turnColor}">${moveResponse.startCellId} → ${moveResponse.endCellId}</span>
                `;

                historyContainer.appendChild(moveItem);
            } catch (error) {
                console.error('Error in Receive handler:', error);
            }
        });

        window.addEventListener('DOMContentLoaded', async () => {
            gameHub.start()
                .then(() => console.log('SignalR connection established'))
                .catch(err => console.error('SignalR connection error:', err));
            await loadCells(gameId);
            updateMovesHistory(gameConfig.moveHistory);
        });

        function formatTimeSpan(tsString) {
            // .NET TimeSpan приходит в формате "hh:mm:ss.fffffff"
            const [timePart, fractionPart] = tsString.split('.');
            const [hh, mm, ss] = timePart.split(':').map(Number);
            const totalSeconds = hh * 3600 + mm * 60 + ss;

            let tenths = '0';
            if (fractionPart) {
                // Преобразуем строку в доли секунды и округляем до десятой
                const ms = parseInt(fractionPart.padEnd(7, '0').slice(0, 7)); // до 7 цифр как в .NET
                tenths = Math.floor(ms / 100_000).toString(); // десятые доли
            }

            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');

            return `${minutes}:${seconds}.${tenths}`;
        }

        function updateTimers() {
            gameConfig.activePlayerIds.forEach(userId => {
                const el = document.getElementById(`timer-${gameConfig.playerColors[userId]}`);
                const ts = gameConfig.playerGameTimes[userId];
                if (el && ts) el.textContent = formatTimeSpan(ts);
            });
        }

        function updateMovesHistory(moves) {
            const container = document.getElementById('moves-history');
            container.innerHTML = moves.length > 0
                ? moves.map((move, index) => {
                    const turnColor = getTurnColorByIndex(index);
                    return `
                <div class="move-item">
                    <span class="move-number">${index + 1}.</span>
                    <span class="move-cells ${turnColor}">${move.startCellId} → ${move.endCellId}</span>
                </div>
            `;
                }).join('')
                : '<div class="no-moves">История ходов пуста</div>';
        }

        function getTurnColorByIndex(index) {
            const colors = ['White', 'Black', 'Red'];
            return colors[index % 3];
        }

        function getColorHex(color) {
            const colors = {
                'White': '#ffffff',
                'Black': '#000000',
                'Red': '#ff4444'
            };
            return colors[color] || '#ccc';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function createMoveElement(move, number) {
            const element = document.createElement('div');
            element.className = 'move-item';
            element.innerHTML = `
                <span class="move-number">${number}.</span>
                <span class="move-player" style="${getColorStyle(move.playerColor)}">
                    ${move.playerColor}
                </span>
                <span class="move-notation">${move.startCell} → ${move.endCell}</span>
                <span class="move-time">${formatTime(move.timestamp)}</span>
            `;
            return element;
        }

        
    </script>
</body>
</html>