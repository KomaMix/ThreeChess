<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chess for Three — Лобби</title>
    <link rel="stylesheet" href="/styles/header.css?v=1.4">
    <link rel="stylesheet" href="/styles/lobby.css?v=1.9">
</head>
<body>
    <header>
        <div class="logo">Chess for Three</div>
        <nav>
            <a href="/Lobby/AllLobbiesPage" class="nav-link">Все лобби</a>
            <a href="#" class="nav-link">Обучение</a>
            <a href="#" class="nav-link">Правила игры</a>
            <a href="/Account/Logout" class="signup">Выйти</a>
        </nav>
    </header>

    <main>
        <section class="lobby-detail">
            <h2>Лобби #<span id="lobby-id">—</span></h2>
            <p>Создано: <span id="lobby-created">—</span></p>
            <p>Игроков: <span id="players-count">0</span>/3</p>
            <ul id="players-list"></ul>
            <button id="leave-btn" disabled>Покинуть лобби</button>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        (function () {
            const parts = window.location.pathname.split('/');
            const lobbyId = parseInt(parts[parts.length - 1], 10);
            let countdownInterval;

            const lobbyHub = new signalR.HubConnectionBuilder()
                .withUrl("/lobbyHub")
                .build();

            lobbyHub.on("GameStarted", (gameId) => {
                clearInterval(countdownInterval);
                window.location.href = `/Game/Play/${gameId}`;
            });

            lobbyHub.on("StartCountdown", startCountdown);
            lobbyHub.on("CancelCountdown", cancelCountdown);

            lobbyHub.on("LobbyUpdated", renderLobby);

            async function handleExit() {
                try {
                    await lobbyHub.invoke("LeaveLobby", lobbyId);
                } catch (err) {
                    console.error("Exit error:", err);
                }
            }

            function renderLobby(lobbyDto) {
                document.getElementById('lobby-id').textContent = lobbyDto.id;
                document.getElementById('lobby-created').textContent =
                    new Date(lobbyDto.createdAt).toLocaleString();
                document.getElementById('players-count').textContent =
                    `${lobbyDto.players.length}`;

                const playersHTML = lobbyDto.players.map(pid => {
                    const nickname = pid.nickname;
                    return `<li>${nickname}</li>`;
                }).join('');

                document.getElementById('players-list').innerHTML = playersHTML;
            }

            function startCountdown() {
                cancelCountdown();
                let seconds = 10; 

                const timer = document.createElement('div');
                timer.id = 'countdown-timer';

                function update() {
                    timer.textContent = `До начала игры: ${seconds} сек.`;
                    if (seconds-- <= 0) {
                        clearInterval(countdownInterval);
                        timer.textContent = "Запуск игры...";
                    }
                }

                update();
                countdownInterval = setInterval(update, 1000);
                document.body.appendChild(timer);
            }

            function cancelCountdown() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                const timer = document.getElementById('countdown-timer');
                if (timer) timer.remove();
            }

            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    await lobbyHub.start();
                    const lobby = await lobbyHub.invoke("GetLobbyInfo", lobbyId);
                    renderLobby(lobby);

                    document.getElementById('leave-btn').disabled = false;
                } catch (err) {
                    console.error(err);
                    alert("Ошибка соединения: " + err);
                }

                document.getElementById('leave-btn').addEventListener('click', async () => {
                    await lobbyHub.invoke("LeaveLobby", lobbyId);
                    window.location.href = "/Lobby/AllLobbiesPage";
                });
            });
        })();
    </script>
</body>
</html>
