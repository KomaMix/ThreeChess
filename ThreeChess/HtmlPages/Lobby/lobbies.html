<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chess for Three - Лобби</title>
    <link rel="stylesheet" href="/styles/lobbies.css?v=1.3">
    <link rel="stylesheet" href="/styles/header.css?v=1.4">
</head>
<body>
    <header>
        <div class="logo">Chess for Three</div>
        <nav>
            <a href="#" class="nav-link">Обучение</a>
            <a href="#" class="nav-link">Правила игры</a>
            <a href="/Game/ActiveGames" class="nav-link">Личный кабинет</a>
            <a href="/Account/Logout" class="signup">Выйти</a>
        </nav>
    </header>

    <main>
        <section class="lobbies-wrapper">
            <h2>Доступные лобби</h2>
            <div class="search-container">
                <div class="search-box">
                    <input type="text" placeholder="Поиск лобби..." disabled>
                    <button disabled>Найти</button>
                </div>
            </div>
            <div id="lobbies-container" class="lobbies-container">
                <div class="loading">Загрузка лобби...</div>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const lobbyHub = new signalR.HubConnectionBuilder()
            .withUrl("/lobbyHub")
            .build();

        lobbyHub.on("LobbyPlayerNumbersChanged", updateLobbyInfo);

        async function start() {
            await lobbyHub.start();
            const lobbies = await lobbyHub.invoke("GetAllLobbies");
            loadLobbiesList(lobbies);
        }

        function loadLobbiesList(lobbies) {
            const container = document.getElementById('lobbies-container');
            container.innerHTML = lobbies.map(lobby => `
                    <div class="lobby-card" data-lobby-id="${lobby.id}">
                        <div class="lobby-info">
                            <h3>Лобби #${ lobby.id.substr(0, 8) }</h3>
                            <p class="player-count">Игроков: ${lobby.playerIds.length}/3</p>
                            <p>Создано: ${new Date(lobby.createdAt).toLocaleTimeString()}</p>
                        </div>
                        <button class="btn-join"
                                data-lobby-id="${lobby.id}"
                                ${lobby.playerIds.length >= 3 ? 'disabled' : ''}>
                            Присоединиться
                        </button>
                    </div>
                `).join('');

            document.querySelectorAll('.btn-join').forEach(btn =>
                btn.addEventListener('click', async e => {
                    const id = e.target.dataset.lobbyId;
                    const success = await lobbyHub.invoke("JoinLobby", id);
                    if (success) {
                        window.location.href = `/Lobby/${id}`;
                    } else {
                        alert("Не удалось присоединиться к лобби");
                    }
                })
            );
        }

        function updateLobbyInfo(lobbyId, playersCount) {
            const lobbyCard = document.querySelector(`.lobby-card[data-lobby-id="${lobbyId}"]`);

            if (!lobbyCard) {
                console.error(`Карточка лобби #${lobbyId} не найдена`);
                return;
            }

            const playerCountElement = lobbyCard.querySelector('p:first-of-type');
            const joinButton = lobbyCard.querySelector('.btn-join');

            if (playerCountElement) {
                playerCountElement.textContent = `Игроков: ${playersCount}/3`;
            }

            if (joinButton) {
                joinButton.disabled = playersCount >= 3;
            }
        }

        document.addEventListener('DOMContentLoaded', start);
    </script>
</body>
</html>